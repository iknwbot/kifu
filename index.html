<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ¦ãƒ¼ã‚¶ç™»éŒ²</title>
    <script src="https://static.line-scdn.net/liff/edge/versions/2.20.0/sdk.js"></script>
    <script src="https://unpkg.com/vconsole/dist/vconsole.min.js"></script>
    <link rel="stylesheet" href="style.css">
    <style>
      .modal {
          display: none;
          position: fixed;
          top: 0; left: 0;
          width: 100%; height: 100%;
          background-color: rgba(0,0,0,0.6);
          justify-content: center;
          align-items: center;
      }
      .modal-content {
          background: #fff;
          padding: 20px;
          border-radius: 10px;
          text-align: center;
          width: 80%;
          max-width: 400px;
          font-size: 18px;
      }
      .modal-content button {
          margin-top: 15px;
          padding: 8px 20px;
          border: none;
          background-color: #4CAF50;
          color: white;
          border-radius: 5px;
          cursor: pointer;
      }
      .modal-content button:hover {
          background-color: #45a049;
      }
    </style>
</head>
<body>

<form id="userForm">
    <h1 id="formTitle" style="display:none;">ãƒ¦ãƒ¼ã‚¶ç™»éŒ²</h1>
    <div id="loading">ãŠå¾…ã¡ãã ã•ã„...</div>
    <div id="userInfo" class="form-group" style="display: none;">
        <p><span id="nickname"></span> ã•ã‚“ã€ä»¥ä¸‹ã‚ˆã‚Šæ‹ ç‚¹åã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚</p>
        <label for="siteSelect">æ‹ ç‚¹:</label>
        <select id="siteSelect"></select>
        <div class="button-group">
            <button id="registerBtn">ç™»éŒ²</button>
        </div>
    </div>
</form>

<!-- ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="customModal" class="modal">
    <div class="modal-content">
        <div id="modalMessage"></div>
        <button onclick="closeModal()">OK</button>
    </div>
</div>

<script>
var vConsole = new VConsole();
console.log("âœ… vConsoleãŒèµ·å‹•ã—ã¾ã—ãŸ");

const LIFF_ID = "2007288533-MplykmDQ";
const BACKEND_URL = "https://script.google.com/macros/s/AKfycbwyDc0GFNBChfjsbiAP9HLmWTWELhUPUOcsbV1iQZagEbUf-wHm1dLYJdx2XTkWLT8E8Q/exec";

let userId, displayName;

async function initLIFF() {
    console.log("ğŸš€ LIFF åˆæœŸåŒ–é–‹å§‹");
    try {
        await liff.init({ liffId: LIFF_ID });
        console.log("âœ… LIFF åˆæœŸåŒ–æˆåŠŸ");

        if (!liff.isLoggedIn()) {
            console.log("âš ï¸ æœªãƒ­ã‚°ã‚¤ãƒ³ã€ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†ã‚’å®Ÿè¡Œ");
            liff.login();
            return;
        }

        console.log("ğŸš€ LIFF ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿");

        const profile = await liff.getProfile();
        userId = profile.userId;
        displayName = profile.displayName;

        console.log("âœ… ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«å–å¾—æˆåŠŸ");
        console.log(`ğŸ‘¤ userId: ${userId}`);
        console.log(`ğŸ‘¤ displayName: ${displayName}`);  // è¿½åŠ : ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã®ãƒ­ã‚°

        // nicknameã‚’ç›´æ¥è¡¨ç¤ºã—ã¦ç¢ºèª
        document.getElementById("nickname").textContent = displayName;
        console.log(`âœ… nickname DOMã«ã‚»ãƒƒãƒˆ: ${displayName}`);

        await checkUserRegistration();
    } catch (error) {
        console.error("âŒ LIFF åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:", error);
        showModal("LIFFã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸã€‚å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚");
    }
}


async function checkUserRegistration() {
    console.log(`â–¶ï¸ checkUserRegistration() å®Ÿè¡Œ: userId=${userId}`);
    try {
        const response = await fetch(`${BACKEND_URL}?action=checkUser&userId=${userId}`);

        console.log("ğŸ“Œ checkUser API response:", response);

        if (!response.ok) {
            throw new Error(`HTTPã‚¨ãƒ©ãƒ¼: ${response.status}`);
        }

        const result = await response.json();
        console.log("âœ… checkUser API parsed JSON:", result);

        if (result.exists) {
            console.log("âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼ç¢ºèªæˆåŠŸ: ãƒ•ã‚©ãƒ¼ãƒ ã¸é·ç§»");
            window.location.href = `form.html?userId=${encodeURIComponent(userId)}&siteName=${encodeURIComponent(result.siteName)}&nickname=${encodeURIComponent(result.nickname)}`;
        } else {
            console.log("âš ï¸ ãƒ¦ãƒ¼ã‚¶ãƒ¼æœªç™»éŒ²: ç™»éŒ²ãƒ•ã‚©ãƒ¼ãƒ ã‚’è¡¨ç¤º");
            await loadSiteOptions();

            // **ã“ã“ã§nicknameã‚’è¡¨ç¤ºã•ã›ã‚‹**
            document.getElementById("nickname").textContent = displayName;

            document.getElementById("loading").style.display = "none";
            document.getElementById("userInfo").style.display = "block";
            document.getElementById("formTitle").style.display = "block";
        }
    } catch (error) {
        console.error("âŒ checkUser ã®ã‚¨ãƒ©ãƒ¼:", error);
        showModal(`ç™»éŒ²çŠ¶æ³ã®ç¢ºèªã«å¤±æ•—ã—ã¾ã—ãŸã€‚\n${error.message}`);
    }
}




async function loadSiteOptions() {
    console.log("ğŸŒ loadSiteOptions() å®Ÿè¡Œ");
    try {
        const response = await fetch(`${BACKEND_URL}?action=getSites`, {
            method: "GET",
            cache: "no-store"
        });

        if (!response.ok) {
            throw new Error(`HTTPã‚¨ãƒ©ãƒ¼: ${response.status}`);
        }

        const sites = await response.json();
        console.log("âœ… getSites API parsed JSON:", sites);

        const select = document.getElementById("siteSelect");
        select.innerHTML = ""; // ä¸€åº¦ã‚¯ãƒªã‚¢

        sites.forEach(site => {
            const option = document.createElement("option");
            option.value = site;
            option.textContent = site;
            select.appendChild(option);
        });

    } catch (error) {
        console.error("âŒ loadSiteOptions ã®ã‚¨ãƒ©ãƒ¼:", error);
        showModal("æ‹ ç‚¹ãƒªã‚¹ãƒˆã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ");
    }
}

    async function registerUser() {
    const siteName = document.getElementById("siteSelect").value;
    console.log("ğŸš€ ãƒ¦ãƒ¼ã‚¶ç™»éŒ²é–‹å§‹: siteName=", siteName);

    try {
        const response = await fetch(BACKEND_URL, {
            method: "POST",
            headers: {
                "Content-Type": "application/x-www-form-urlencoded"
            },
            body: new URLSearchParams({
                action: "donation_registerUser",
                userId: userId,
                displayName: displayName,
                siteName: siteName
            })
        });

        const result = await response.json();
        console.log("âœ… ç™»éŒ²æˆåŠŸ:", result);

        if (result.status === "success") {
            showModal("ç™»éŒ²ãŒå®Œäº†ã—ã¾ã—ãŸï¼", () => window.location.reload());
        } else {
            throw new Error(result.message);
        }

    } catch (error) {
        console.error("âŒ ç™»éŒ²ã‚¨ãƒ©ãƒ¼:", error);
        showModal(`ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}`);
    }
}

document.getElementById("registerBtn").addEventListener("click", async (event) => {
    event.preventDefault();
    await registerUser();
});


function showModal(message, callback = null) {
    document.getElementById("modalMessage").innerHTML = message;
    const modal = document.getElementById("customModal");
    modal.style.display = "flex";
    modal.callback = callback;
}

function closeModal() {
    const modal = document.getElementById("customModal");
    modal.style.display = "none";
    if (modal.callback) modal.callback();
}

window.onload = function() {
    console.log("ğŸŒ window.onload ã‚¤ãƒ™ãƒ³ãƒˆç™ºç«");
    initLIFF();
};
</script>

</body>
</html>
